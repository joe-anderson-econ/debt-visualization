<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>US Debt Financing Decomposition</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/recharts@2.5.0/dist/Recharts.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 6px;
        }
        .control-group {
            display: flex;
            flex-direction: column;
        }
        label {
            font-weight: 600;
            margin-bottom: 6px;
            color: #333;
            font-size: 14px;
        }
        select, input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            background: white;
        }
        select:focus, input:focus {
            outline: none;
            border-color: #1f77b4;
        }
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
        }
        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        .checkbox-group label {
            margin: 0;
            cursor: pointer;
            font-weight: 500;
        }
        button {
            padding: 10px 24px;
            background: #1f77b4;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            align-self: flex-start;
        }
        button:hover {
            background: #1557a0;
        }
        button:active {
            transform: translateY(1px);
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .error {
            background: #fee;
            border: 1px solid #fcc;
            color: #c33;
            padding: 16px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        h1 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #222;
        }
        .subtitle {
            color: #666;
            margin-bottom: 24px;
        }
        .stats {
            margin-top: 20px;
            padding: 16px;
            background: #f9f9f9;
            border-radius: 4px;
            font-size: 13px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-top: 12px;
        }
        .stat-item {
            padding: 8px;
            background: white;
            border-radius: 4px;
            border-left: 3px solid #1f77b4;
        }
        .stat-label {
            font-weight: 600;
            color: #555;
        }
        .stat-value {
            font-size: 16px;
            font-weight: 700;
            color: #222;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } = Recharts;

        const DebtVisualization = () => {
            const [csvData, setCsvData] = useState([]);
            const [startYear, setStartYear] = useState(2020);
            const [startQuarter, setStartQuarter] = useState(1);
            const [endYear, setEndYear] = useState(2025);
            const [endQuarter, setEndQuarter] = useState(2);
            const [excludeSmall, setExcludeSmall] = useState(true);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [csvUrl, setCsvUrl] = useState('output_budget_decomposition.csv');

            const MAGNITUDE_THRESHOLD = 0.01;
            const COLORS = ['#1f77b4', '#d62728', '#ff7f0e', '#2ca02c', '#9467bd', '#8c564b', '#e377c2', '#7f7f7f'];

            const VARIABLE_MAPPING = {
                'LHS': 'DebtToGDP',
                'primary_deficit': 'PrimaryDeficit',
                'return_treasury': 'IntOnTreasuries',
                'inflation_effect': 'Inflation',
                'growth_effect': 'Growth',
                'return_reserves': 'IntOnReserves',
                'return_revrepo': 'IntOnRevRepos'
            };

            const DISPLAY_ORDER = [
                'DebtToGDP',
                'PrimaryDeficit',
                'IntOnTreasuries',
                'Inflation',
                'Growth',
                'IntOnReserves',
                'IntOnRevRepos'
            ];

            // Parse CSV text
            const parseCSV = (text) => {
                const lines = text.trim().split('\n');
                const headers = lines[0].split(',');
                
                return lines.slice(1).map(line => {
                    const values = line.split(',');
                    const row = {};
                    headers.forEach((header, i) => {
                        const value = values[i];
                        row[header] = isNaN(value) || value === '' ? value : parseFloat(value);
                    });
                    return row;
                });
            };

            // Load CSV data
            useEffect(() => {
                const loadCSV = async () => {
                    try {
                        setLoading(true);
                        setError(null);
                        const response = await fetch(csvUrl);
                        if (!response.ok) {
                            throw new Error(`Failed to load CSV: ${response.statusText}`);
                        }
                        const text = await response.text();
                        const data = parseCSV(text);
                        setCsvData(data);
                        setLoading(false);
                    } catch (err) {
                        setError(err.message);
                        setLoading(false);
                    }
                };
                loadCSV();
            }, [csvUrl]);

            // Get available year range from data
            const yearRange = useMemo(() => {
                if (csvData.length === 0) return { min: 1947, max: 2025 };
                const years = csvData.map(row => parseInt(row.quarter.split('Q')[0]));
                return { min: Math.min(...years), max: Math.max(...years) };
            }, [csvData]);

            // Calculate quarter string
            const createQuarterStr = (year, quarter) => `${year}Q${quarter}`;

            // Get previous quarter
            const getPreviousQuarter = (year, quarter) => {
                if (quarter === 1) return { year: year - 1, quarter: 4 };
                return { year, quarter: quarter - 1 };
            };

            // Process data for visualization
            const processedData = useMemo(() => {
                if (csvData.length === 0) return { chartData: [], variablesToPlot: [], stats: {} };

                const startQtr = createQuarterStr(startYear, startQuarter);
                const endQtr = createQuarterStr(endYear, endQuarter);
                
                // Filter data to date range
                const filtered = csvData.filter(row => 
                    row.quarter >= startQtr && row.quarter <= endQtr
                );

                if (filtered.length === 0) {
                    return { chartData: [], variablesToPlot: [], stats: {} };
                }

                // Add initial zero point
                const prev = getPreviousQuarter(startYear, startQuarter);
                const initialRow = { quarter: createQuarterStr(prev.year, prev.quarter) };
                Object.keys(VARIABLE_MAPPING).forEach(key => {
                    initialRow[key] = 0;
                });

                const dataWithInitial = [initialRow, ...filtered];

                // Calculate cumulative sums
                const cumulative = {};
                const maxAbsValues = {};
                
                Object.entries(VARIABLE_MAPPING).forEach(([csvName, displayName]) => {
                    let sum = 0;
                    cumulative[displayName] = dataWithInitial.map(row => {
                        sum += (row[csvName] || 0);
                        return sum;
                    });
                    maxAbsValues[displayName] = Math.max(...cumulative[displayName].map(Math.abs));
                });

                // Filter variables by threshold if requested
                let variablesToPlot = DISPLAY_ORDER;
                if (excludeSmall) {
                    variablesToPlot = DISPLAY_ORDER.filter(name => 
                        maxAbsValues[name] > MAGNITUDE_THRESHOLD
                    );
                }

                // Build chart data
                const chartData = dataWithInitial.map((row, idx) => {
                    const point = { quarter: row.quarter };
                    variablesToPlot.forEach(varName => {
                        point[varName] = cumulative[varName][idx];
                    });
                    return point;
                });

                // Calculate final statistics
                const stats = {};
                variablesToPlot.forEach(varName => {
                    stats[varName] = cumulative[varName][cumulative[varName].length - 1];
                });

                return { chartData, variablesToPlot, stats };
            }, [csvData, startYear, startQuarter, endYear, endQuarter, excludeSmall]);

            // Custom tooltip
            const CustomTooltip = ({ active, payload, label }) => {
                if (!active || !payload) return null;
                return (
                    <div style={{
                        background: 'white',
                        padding: '12px',
                        border: '1px solid #ccc',
                        borderRadius: '4px',
                        boxShadow: '0 2px 8px rgba(0,0,0,0.15)'
                    }}>
                        <p style={{ fontWeight: 'bold', margin: '0 0 8px 0' }}>{label}</p>
                        {payload.map((entry, idx) => (
                            <p key={idx} style={{ margin: '4px 0', color: entry.color, fontSize: '13px' }}>
                                {entry.name}: {entry.value.toFixed(4)}
                            </p>
                        ))}
                    </div>
                );
            };

            if (loading) {
                return (
                    <div className="container">
                        <div className="loading">Loading data...</div>
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="container">
                        <div className="error">
                            <strong>Error:</strong> {error}
                            <p style={{marginTop: '8px', fontSize: '13px'}}>
                                Make sure the CSV file 'output_budget_decomposition.csv' is in the same directory as this HTML file.
                            </p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="container">
                    <h1>US Debt Financing Decomposition</h1>
                    <p className="subtitle">Interactive visualization of budget decomposition data</p>

                    <div className="controls">
                        <div className="control-group">
                            <label>Start Year</label>
                            <select value={startYear} onChange={e => setStartYear(parseInt(e.target.value))}>
                                {Array.from({ length: yearRange.max - yearRange.min + 1 }, (_, i) => yearRange.min + i).map(year => (
                                    <option key={year} value={year}>{year}</option>
                                ))}
                            </select>
                        </div>

                        <div className="control-group">
                            <label>Start Quarter</label>
                            <select value={startQuarter} onChange={e => setStartQuarter(parseInt(e.target.value))}>
                                {[1, 2, 3, 4].map(q => (
                                    <option key={q} value={q}>Q{q}</option>
                                ))}
                            </select>
                        </div>

                        <div className="control-group">
                            <label>End Year</label>
                            <select value={endYear} onChange={e => setEndYear(parseInt(e.target.value))}>
                                {Array.from({ length: yearRange.max - yearRange.min + 1 }, (_, i) => yearRange.min + i).map(year => (
                                    <option key={year} value={year}>{year}</option>
                                ))}
                            </select>
                        </div>

                        <div className="control-group">
                            <label>End Quarter</label>
                            <select value={endQuarter} onChange={e => setEndQuarter(parseInt(e.target.value))}>
                                {[1, 2, 3, 4].map(q => (
                                    <option key={q} value={q}>Q{q}</option>
                                ))}
                            </select>
                        </div>

                        <div className="control-group">
                            <label>Filter Options</label>
                            <div className="checkbox-group">
                                <input 
                                    type="checkbox" 
                                    id="excludeSmall" 
                                    checked={excludeSmall}
                                    onChange={e => setExcludeSmall(e.target.checked)}
                                />
                                <label htmlFor="excludeSmall">Exclude small series (&lt;1%)</label>
                            </div>
                        </div>
                    </div>

                    {processedData.chartData.length > 0 ? (
                        <>
                            <ResponsiveContainer width="100%" height={500}>
                                <LineChart data={processedData.chartData} margin={{ top: 5, right: 30, left: 20, bottom: 60 }}>
                                    <CartesianGrid strokeDasharray="3 3" opacity={0.3} />
                                    <XAxis 
                                        dataKey="quarter" 
                                        angle={-45} 
                                        textAnchor="end" 
                                        height={80}
                                        interval="preserveStartEnd"
                                        tick={{ fontSize: 11 }}
                                    />
                                    <YAxis tick={{ fontSize: 11 }} />
                                    <Tooltip content={<CustomTooltip />} />
                                    <Legend wrapperStyle={{ paddingTop: '20px' }} />
                                    {processedData.variablesToPlot.map((varName, idx) => (
                                        <Line
                                            key={varName}
                                            type="monotone"
                                            dataKey={varName}
                                            stroke={COLORS[idx % COLORS.length]}
                                            strokeWidth={2}
                                            dot={false}
                                            activeDot={{ r: 4 }}
                                        />
                                    ))}
                                </LineChart>
                            </ResponsiveContainer>

                            <div className="stats">
                                <strong>Final Cumulative Values ({createQuarterStr(endYear, endQuarter)})</strong>
                                <div className="stats-grid">
                                    {processedData.variablesToPlot.map(varName => (
                                        <div key={varName} className="stat-item">
                                            <div className="stat-label">{varName}</div>
                                            <div className="stat-value">{processedData.stats[varName].toFixed(4)}</div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </>
                    ) : (
                        <div className="error">
                            No data available for the selected date range. Please adjust your parameters.
                        </div>
                    )}
                </div>
            );
        };

        ReactDOM.render(<DebtVisualization />, document.getElementById('root'));
    </script>
</body>
</html>